---
title: "Windows11とVSCodeでC++版OpenCVの開発環境構築"
emoji: "🛠️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["OpenCV", "Windows"]
published: true
---

WindowsでOpenCVの開発を行おうとするとVisual Studioの使用例ばかり出てきますが、使い慣れたVSCodeを使いたかったので、Visual Studioを使わずに開発できる環境を構築していきます。  

環境は以下の通りです。  

- Windows 11
- OpenCV 4.9
- PowerShell 7.3
- CMake 3.27

## CMakeのインストール

```sh
winget install Kitware.CMake
```

でインストールできます。  
もしwingetがない場合は [アプリインストーラー](https://apps.microsoft.com/detail/9nblggh4nns1?rtc=1&hl=ja-jp&gl=JP)をインストールしてください。  

:::details wingetを使わずに入れる方法

https://github.com/Kitware/CMake/releases

`cmake-{version}-windows-x86_64.msi` をダウンロード & インストールしてください。  

:::

## OpenCVのインストール

https://github.com/opencv/opencv/releases

上記リンクから `opencv-{version}-windows.exe` をダウンロードします。  

ダウンロード後、実行するとOpenCVのインストールフォルダを選択する画面になるので、適当なパスを設定します。  
ここでは `C:\Users\{user}\env` 下にインストールするものとします。  

インストール後、環境変数を設定します。  
PowerShellを開き、

```txt
setx OpenCV_DIR C:\Users\{user}\env\OpenCV\build\x64\vc17
```

と入力して下さい。  
また、ユーザー環境変数の `Path` に `%OPENCV_DIR%\bin` と `%OPENCV_DIR%\lib` を追加してください。  

環境変数の設定後、PowerShellを開き直し、 `opencv_version` と入力して以下のようにバージョン情報が出てくればOKです。  

```txt
$ opencv_version
4.9.0
```

詳しい環境変数の設定方法は以下のサイトを参照してください。  
https://docs.opencv.org/4.x/d3/d52/tutorial_windows_install.html#tutorial_windows_install_path

:::details ソースコードからビルドする場合

自分でビルドする場合には `msbuild` が必要です。  
Visual Studio 2022 をインストールするか [ビルドツールをインストール](https://www.kkaneko.jp/tools/win/buildtool2022.html)してください。  

1. ディレクトリを作成する。  

```sh
mkdir opencv
cd opencv
```

2. opencvとopencv_contribをダウンロードする。  

```sh
curl -Lo opencv.zip https://github.com/opencv/opencv/archive/4.x.zip
curl -Lo opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/4.x.zip
```

3. 解凍する。  

`Expand-Archive`で解凍できますが、`opencv/opencv-4.x/…`のようなパスになるので7zipでやるか解凍後手動でフォルダーの移動をおすすめします。  

4. ビルド用ディレクトリを作成する。  

```sh
mkdir build
cd build
```

5. ビルドする。  

Visual Studio 17 2022で、x64向けのReleaseビルドを行っています。  

```sh
cmake -G "Visual Studio 17 2022" -A x64 -D OPENCV_EXTRA_MODULES_PATH=../opencv_contrib-4.x/modules -D BUILD_opencv_world=ON ../opencv-4.x
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe' .\ALL_BUILD.vcxproj /p:Configuration=Release /p:Platform=x64
& 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe' .\INSTALL.vcxproj /p:Configuration=Release /p:Platform=x64
```

6. パスを通す。

※パスは適宜読み替えてください。  

- `C:\opencv\build\install`
- `C:\opencv\build\install\include`
- `C:\opencv\build\install\x64\vc17\bin`

パスを通した後、PowerShellで`opencv_version`と入力して、バージョン情報が出てきたらOK。  

:::

## OpenCVを使ってみる

これで環境は整ったのでOpenCVを使ったテストプログラムを作成します。  
`main.cpp` と `CMakeLists.txt` の2つのプログラムを用意します。  

```cpp:main.cpp
#include "opencv2/highgui/highgui.hpp"
#include "opencv2/opencv.hpp"

int main() {
    cv::VideoCapture cap(0);
    if (!cap.isOpened()) return -1;

    cv::Mat frame;
    while (cap.read(frame)) {
        cv::imshow("test", frame);
        const int key = cv::waitKey(1);
        if (key == 'q') break;
    }
    cv::destroyAllWindows();

    return 0;
}
```

```cmake:CMakeLists.txt
cmake_minimum_required(VERSION 3.0.0)
project(test VERSION 0.1.0 LANGUAGES CXX)

find_package(OpenCV REQUIRED)
include_directories(${OpenCV_INCLUDE_DIRS})

add_executable(test main.cpp)
target_link_libraries( ${PROJECT_NAME} ${OpenCV_LIBS} )
```

ビルドします。  

```sh
cmake . -B build && cmake --build build --config Release && build\Release\test.exe
```

ウィンドウが表示され、Webcamの映像が表示されれば成功です！  

## 参考文献

https://docs.opencv.org/4.x/d7/d9f/tutorial_linux_install.html
https://swallow-incubate.com/archives/blog/20200508
https://sh-yoshida.hatenablog.com/entry/2017/05/27/012755
https://pystyle.info/opencv-how-to-build-opencv-on-windows
