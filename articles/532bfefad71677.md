---
title: "Kubernetesã«Bitwarden Secrets Managerã‚’å°å…¥ã—ã¦ã¿ã‚‹"
emoji: "ğŸ”’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes", "bitwarden"]
published: true
---

è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã§k8sã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€Secretã®ç®¡ç†ã«é ­ã‚’æ‚©ã¾ã›ã¦ã„ã¾ã—ãŸã€‚  
kubectlã§ç®¡ç†ã™ã‚‹ã®ã¯é¢å€’ãã•ã„ã—ã€è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ãªã®ã§ãƒ­ã‚¹ãƒˆã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚  
ã“ã‚Œã‚’æ”¹å–„ã—ã‚ˆã†ã¨èª¿ã¹ã¦ã¿ã‚‹ã¨ã€ã„ãã¤ã‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã—ãŸã€‚  

1. `Portainer` ã‚„ `Lens` ã§Secretã®GUIç®¡ç†
    â†’ è‡ªå®…k8sã§ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒŸã‚¹ã§Secretã‚’å¤±ã†å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŸã‚å´ä¸‹  

2. `Sealed Secrets` ã‚„ `sops` ã¨ã„ã£ãŸæš—å·åŒ–æ¸ˆã¿ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›¸ãè¾¼ã¿ã€ä½¿ç”¨æ™‚ã«å¾©å·ã™ã‚‹æ–¹å¼
    â†’ æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã¯ã„ãˆGitå±¥æ­´ã«æ®‹ã‚‹ã®ãŒå«Œ  

3. `Bitwarden Secrets Manager(BSM)` ã¨ `External Secrets Operator(ESO)` ã§ç®¡ç†
    â†’ æ™®æ®µã‹ã‚‰Bitwardenã‚’ä½¿ç”¨ã—ã¦ã„ãŸã“ã¨ã¨ã€å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã«é ã‘ã‚‰ã‚Œã‚‹ã®ã§ãƒ‡ãƒ¼ã‚¿ã‚’å¤±ã†ç¢ºç‡ãŒè‡ªåˆ†ã§ç®¡ç†ã™ã‚‹ã‚ˆã‚Šä½ã„ã ã‚ã†

ãƒ‘ãƒƒã¨ã“ã®3ã¤ãŒä¸ŠãŒã£ãŸã®ã§ã™ãŒã€3ã‚’é¸æŠã—ã¾ã—ãŸã€‚  
èª¿ã¹ã¦ã‚‚BSMã®æƒ…å ±ã¯ã‚ã¾ã‚Šãªã‹ã£ãŸã®ã§è¨˜äº‹ã«ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚  
ã¡ãªã¿ã« `Bitwarden Passowrd Manager` ã¨ `Bitwarden Secrets Manager` ã¯å…¨ãã®åˆ¥ç‰©ãªã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚  
Password Managerã®æ–¹ã¯1Passowrdã¿ãŸã„ãªã‚ˆãã‚ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã€Secrets Managerã¯AWS Secrets Mangerã®ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒå‘ã‘ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚  

## å°å…¥

### External Secrets Operator (ESO) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã¯Helmã§External Secrets Operatorã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  
BSMã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Bitwarden SDK Serverã‚‚ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  

https://external-secrets.io/latest/provider/bitwarden-secrets-manager

```bash
# Helmãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
helm repo add external-secrets https://charts.external-secrets.io

# External Secrets Operatorã¨Bitwarden SDK Serverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
helm install external-secrets \
  external-secrets/external-secrets \
  -n external-secrets \
  --create-namespace \
  --set bitwarden-sdk-server.enabled=true
```

Bitwarden SDK Serverã¯HTTPSã§å‹•ä½œã™ã‚‹ã®ã§ã€cert-managerã§è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
cert-managerãŒã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å…ˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚  

### Bitwarden Secrets Managerã®æº–å‚™

BSMã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€Machine AccountãŒå¿…è¦ã§ã™ã€‚  
Bitwardenã®Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Machine Accountã‚’ä½œæˆã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚  

å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’Kubernetes Secretã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚  

```bash
kubectl create secret generic bitwarden-access-token \
  -n default \
  --from-literal=token='YOUR_ACCESS_TOKEN_HERE'
```

### SecretStore ã®è¨­å®š

SecretStoreã‚’ä½œæˆã—ã¦ã€ESOãŒBSMã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚  

```yaml
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: bitwarden-secretsmanager
spec:
  provider:
    bitwardensecretsmanager:
      apiURL: https://api.bitwarden.com
      identityURL: https://identity.bitwarden.com
      auth:
        secretRef:
          credentials:
            key: token
            name: bitwarden-access-token
      bitwardenServerSDKURL: https://bitwarden-sdk-server.external-secrets.svc.cluster.local:9998
      # cert-managerã§ç”Ÿæˆã—ãŸè¨¼æ˜æ›¸ã®CA Bundleã‚’è¨­å®š
      caBundle: "<BASE64_ENCODED_CA_CERTIFICATE>"
      # BSMã®Organization ID
      organizationID: "your-organization-id"
      # BSMã®Project ID
      projectID: "your-project-id"
```

:::message
SecretStoreã¯1ã¤ã®Organization/Projectã«ã¤ã1ã¤ã§ã™ã€‚  
åˆ¥ã®Projectã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã—ãŸã„å ´åˆã¯ã€åˆ¥ã®SecretStoreã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚  
:::

### ExternalSecret ã®è¨­å®š

SecretStoreã®æº–å‚™ãŒã§ããŸã‚‰ã€ExternalSecretã‚’ä½œæˆã—ã¦BSMã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

#### UUIDã§å–å¾—ã™ã‚‹å ´åˆ

```yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: my-external-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: SecretStore
  target:
    name: my-k8s-secret
    creationPolicy: Owner
  data:
    - secretKey: my-secret-key
      remoteRef:
        key: "339062b8-a5a1-4303-bf1d-b1920146a622"  # BSMã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆUUID
```

#### åå‰ã§å–å¾—ã™ã‚‹å ´åˆ

```yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: my-external-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: SecretStore
  target:
    name: my-k8s-secret
    creationPolicy: Owner
  data:
    - secretKey: my-secret-key
      remoteRef:
        key: "secret-name"  # BSMã§è¨­å®šã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå
```

### å‹•ä½œç¢ºèª

ExternalSecretãŒæ­£ã—ãåŒæœŸã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚  

```bash
kubectl get externalsecret my-external-secret

# å‡ºåŠ›ä¾‹
# NAME                 STORE                     REFRESH INTERVAL   STATUS         READY
# my-external-secret   bitwarden-secretsmanager  1h                 SecretSynced   True
```

StatusãŒSecretSyncedã«ãªã£ã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚  
ä½œæˆã•ã‚ŒãŸSecretã®å†…å®¹ã‚‚ç¢ºèªã§ãã¾ã™ã€‚  

```bash
kubectl get secret my-k8s-secret -o jsonpath='{.data.my-secret-key}' | base64 -d
```
