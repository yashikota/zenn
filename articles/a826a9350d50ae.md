---
title: "AWS Amplifyã§Secrets Managerã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•"
emoji: "ãŠ™ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "amplify", "secretsmanager"]
published: true
publication_name: "univearth"
---

ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†ã«AWSã®Secrets Managerã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€AWS Amplifyã§ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã„ã‚‹æ™‚ã«æ‰±ã„ã«å›°ã‚Šã¾ã—ãŸã€‚  
ã¨è¨€ã†ã®ã‚‚ã€Amplifyã¯Amplifyã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã€ç›´æ¥Secrets Managerã¯èª­ã¿è¾¼ã‚“ã§ãã‚Œãªã„ã‹ã‚‰ã§ã™ã€‚  

https://docs.amplify.aws/react/deploy-and-host/fullstack-branching/secrets-and-vars/

ã ã‹ã‚‰ã¨è¨€ã£ã¦Secrets Managerã¨Amplifyã®2é‡ã§ç®¡ç†ã—ã¦ã—ã¾ã†ã¨ç®¡ç†ã‚³ã‚¹ãƒˆãŒé‡ããªã£ã¦ã—ã¾ã†ã®ã§ã€é¿ã‘ãŸã„ã¨ã“ã‚ã§ã—ãŸã€‚  
ãã“ã§ã€Amplifyã®ãƒ“ãƒ«ãƒ‰æ™‚ã«awsã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦Secrets Managerã‹ã‚‰pullã—ã¦ãã¦ `.env` ã«ã™ã‚‹ã“ã¨ã§ã€ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†ã‚’Secrets Managerã«ä¸€æœ¬åŒ–ã§ããŸã®ã§ã€æ–¹æ³•ã‚’å…±æœ‰ã—ã¾ã™ã€‚  

## 1. IAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ä»˜ä¸

ã¾ãšã€AmplifyãŒSecrets Managerã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã€é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

1. Amplifyã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§`ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š > IAMãƒ­ãƒ¼ãƒ« > ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«` ã®ä¸‹ã«ã‚ã‚‹ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `è¨±å¯ãƒãƒªã‚·ãƒ¼ã®è¨±å¯ã‚’è¿½åŠ  > ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ > ãƒãƒªã‚·ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®JSON` ã§ä»¥ä¸‹ã®å†…å®¹ã‚’è¿½åŠ 

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ReadSecrets",
            "Effect": "Allow",
            "Action": "secretsmanager:GetSecretValue",
            "Resource": "*"
        }
    ]
}
```

ãƒãƒªã‚·ãƒ¼åã¯ `SecretsManagerRead` ãªã©ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã§ä¿å­˜ã—ã¾ã™ã€‚  
ã¾ãŸä»Šå›ã¯Resourceã‚’ä¾¿å®œä¸Š `*` ã¨ã—ã¾ã—ãŸãŒã€æœ¬ç•ªç’°å¢ƒã§ã¯ARNã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚  

## 2. `amplify.yaml`ã®è¨­å®š

ä»Šå›ã¯AWSå…¬å¼ã®Next.jsãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

https://github.com/aws-samples/amplify-next-template

Amplifyã§ã¯`amplify.yaml`ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸï¼š

```yaml
version: 1

frontend:
  phases:
    preBuild:
      commands:
        - sudo yum -y install jq
        - |
          aws secretsmanager get-secret-value \
            --secret-id test \
            --region ap-northeast-1 \
            --query SecretString \
            --output text | \
          jq -r 'to_entries|map("\(.key)=\(.value)")|.[]' >> .env
    build:
      commands:
        - npm ci --cache .npm --prefer-offline
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
      - node_modules/**/*
```

ãƒã‚¤ãƒ³ãƒˆã¯ `preBuild` ãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚ã“ã“ã§aws cliã‚’ä½¿ã£ã¦Secrets Managerã‹ã‚‰å€¤ã‚’å–å¾—ã—ã€ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¦ã„ã¾ã™ã€‚  
ã“ã®éš›Secrets Managerã‹ã‚‰å–å¾—ã—ãŸå€¤ã¯ `.env` å½¢å¼ã§ã¯ãªã„ãŸã‚ã€ `jq` ã‚³ãƒãƒ³ãƒ‰ã§é©åˆ‡ã«æ•´å½¢ã—ã¦ã„ã¾ã™ã€‚

ãªãŠã€ã“ã®æ–¹æ³•ã§ã¯åŒä¸€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®Secrets Managerã«ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®èª­ã¿å–ã‚Šã¯AWS KMSã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã®ã¿å¯èƒ½ã§ã€AWSãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æš—å·åŒ–ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã§ãã¾ã›ã‚“ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚  

https://docs.aws.amazon.com/ja_jp/secretsmanager/latest/userguide/auth-and-access_examples_cross.html

ã“ã‚Œã§è¨­å®šã¯å®Œäº†ã§ã™ï¼Secrets Managerã§ä¸€å…ƒç®¡ç†ã—ãŸç’°å¢ƒå¤‰æ•°ã‚’Amplifyã®ãƒ“ãƒ«ãƒ‰æ™‚ã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸğŸ˜Š  
